# Mandelbrot set

## Введение

Множество Мандельброта - множество точек плоскости, для задания которого каждой точке `A` с координатами `(x,y)` соответствует последовательность:

$$(x_0, y_0) = (x, y)               $$
$$ x_i = x_{i-1}^2 - y_{i-1}^2 + x_0$$
$$ y_i = 2x_{i-1} y_{i-1} + y_0     $$

Если последовательность ограничена, точка принадлежит множеству Мандельброта, иначе - нет.

Примерно так выглядит множество Мандельброта:

![Maldenbrot set](maldenbrot.png "Maldenbrot set")

## Реализация

Для визуализации множества Мандельброта можно определить цвет пикселя, как функцию от `k`, где $|\vec{r}(x_k, y_k)| > R$, а $\forall i < k: |\vec{r}(x_i, y_i)|\leq R, (R - const)$.

Узким местом в программе является цикл, вычисляющий элементы последовательности выше, для нахождения `k`, по которому пересчитывается цвет пикселя. Реализовать вычисления можно разными способами:

* ### Попиксельная обработка
* ### Развертка цикла
* ### SIMD инструкции

Для определения производительности каждой реализации отдельная программа запускала узкое место `100` раз  при размере окна `800*800` и находила среднее время выполнения.

Среда тестирования:

| CPU                   | Compiler   | OS                     |
|-----------------------|------------|------------------------|
| AMD Ryzen 7 PRO 5850U | GCC 11.3.0 | Linux Mint 21 Cinnamon |

Флаги сборки:
```
-O3 -mavx2
```

Результаты тестирования:

| Версия    | Время, мс | Коэффициент ускорения относительно начальной версии |
|-----------|-----------|-----------------------------------------------------|
| simple    |  68.16    | 1.00 (начальная версия)                             |
| all in    | 106.84    | 0.64                                                |
| separated |  94.80    | 0.72                                                |
| intrin    |  19.98    | 3.41                                                |

Описание версий (исходный код версий в src/maldenbrot_frame.cpp):

`simple` - попиксельная обработка

`all in` - развертка цикла, циклы векторизации в функции с узким местом

`separated` - развертка цикла, циклы векторизации в отдельных inline функциях

`intrin` - векторизация с использованием `AVX, AVX2` инструкций

## Вывод

Исходя из ассемблерного кода, сгенерированного компилятором, можно сделать следующие выводы:

### [***all in***](https://godbolt.org/z/ohnY9GE1j) & [***separated***](https://godbolt.org/z/8z45Y7fa1)

Компилятор свернул циклы векторизации в инструкции, оперирующие с 128-битными регистрами, но из-за большого количества обращений к памяти обе версии медленнее, чем `simple`.

![all_in screen](godbolt_screen/all_in.png)

`separated` немного быстрее, чем `all in`, вероятно, засчет выноса циклов в отдельные функции, что упростило поиск оптимизаций.

### [***intrin***](https://godbolt.org/z/r1c6PrWEj) & [***simple***](https://godbolt.org/z/hMT519hMY)

В `intrin` компилятор использует инструкции с 256-битными `ymm` регистрами, куда помещается 4 переменных типа double. Побочных юбращений к памяти нет.

![intrin screen](godbolt_screen/intrin.png)

В идеале ускорение должно быть в 4 раза, но этого не произошло, из-за некоторых накладных расходов, к тому же в `simple` версии тоже есть параллелизм, хоть и в меньшей степени. Например операции сложения и умножения ниже не имеют зависимостей по данным и будут конвееризованны:

![simple screen](godbolt_screen/simple.png)

Также компилятор переставил инструкции местами (на фото цвета строк чередуются) для увелечения конвееризации.

## Как запустить тестирование

OS Linux:
```
cd src
make time
./time          // run all versions
./time --help   // show manual
```

Настройки (кол-во тестов для усреднения, размеры окна и т.д.) в src/maldenbrot_settings.h
